load_module modules/ngx_http_headers_more_filter_module.so;
load_module modules/ngx_http_proxy_connect_module.so;

http {
    # Include default Nginx configurations
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Logging settings
    access_log    /var/log/nginx/access.log;
    error_log     /var/log/nginx/error.log;

    # Server block for HTTP
    server {
        listen 80;
        server_name ${SERVER_NAME}; # Replace ${SERVER_NAME} with your actual server name

        location ~ ^/ohttp-relay(/|$) {
            more_clear_input_headers '*';
            proxy_pass https://${OHTTP_GATEWAY}; # Replace ${OHTTP_GATEWAY} with your actual gateway address
            # Strip the /ohttp-relay prefix
            rewrite ^/ohttp-relay(/.*)$ $1 break;
        }
    }

    # Server block for HTTPS
    server {
        listen 443 ssl;
        server_name ${SERVER_NAME}; # Replace ${SERVER_NAME} with your actual server name

        # SSL configuration
        ssl_certificate /path/to/ssl/nginx.crt; # Path to your SSL certificate
        ssl_certificate_key /path/to/ssl/nginx.key; # Path to your SSL private key

        # SSL settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        location ~ ^/ohttp-relay(/|$) {
            more_clear_input_headers '*';
            proxy_pass https://${OHTTP_GATEWAY}; # Replace ${OHTTP_GATEWAY} with your actual gateway address
            # Strip the /ohttp-relay prefix
            rewrite ^/ohttp-relay(/.*)$ $1 break;
        }

        # Special handling for CONNECT method with HTTPS
        location = /ohttp-config {
            proxy_connect;
            proxy_connect_allow all;
            proxy_connect_connect_timeout 10s;
            proxy_connect_read_timeout 10s;
            proxy_connect_send_timeout 10s;

            proxy_pass https://${OHTTP_GATEWAY}/ohttp-config;

            # SSL client certificate authentication is unnecessary because we operate a strict whitelist
        }
    }
}

